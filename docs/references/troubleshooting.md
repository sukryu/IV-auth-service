# 문제 해결 가이드

본 문서는 **ImmersiVerse Authentication Service**에서 자주 발생하는 문제 상황과 그에 대한 해결 방법을 정리한 문제 해결 가이드입니다. 이 가이드는 운영자와 개발자가 신속하게 문제를 진단하고 해결할 수 있도록, 증상, 원인, 대응 방법을 단계별로 제시합니다.

---

## 1. 인증 관련 문제

### 1.1 로그인 실패 / 인증 오류

- **증상**:  
  - 사용자가 올바른 자격 증명을 입력했음에도 불구하고 로그인 실패
  - 401 Unauthorized 에러 반환

- **원인**:  
  - 비밀번호 해싱 불일치 (Argon2id 파라미터 불일치)
  - DB 연결 문제로 인한 사용자 정보 조회 실패
  - JWT 토큰 서명 검증 실패 또는 만료
  - 내부 캐시(Redis) 문제로 블랙리스트 정보 누락

- **해결 방법**:  
  1. 애플리케이션 로그에서 로그인 실패 원인(예: 해싱 오류, DB 오류, 토큰 오류) 확인  
  2. DB 연결 상태 및 사용자 데이터의 정확성 점검  
  3. JWT 생성/검증 시 사용되는 RS256 키의 유효성과 키 순환 정책 검토  
  4. Redis 캐시 상태 점검 및 블랙리스트 업데이트 여부 확인  
  5. 필요한 경우, 서비스 재시작 및 관련 환경 변수 재설정

---

## 2. gRPC 통신 문제

### 2.1 gRPC 연결 실패

- **증상**:  
  - 클라이언트에서 gRPC 호출 시 연결 오류 발생  
  - `Unavailable` 또는 `DeadlineExceeded` 에러 반환

- **원인**:  
  - 네트워크 문제(방화벽, 서비스 디스커버리 실패)  
  - Auth Service의 gRPC 서버가 다운된 경우  
  - 잘못된 포트 또는 인증서 설정

- **해결 방법**:  
  1. 서비스 디스커버리(Kubernetes DNS) 및 네트워크 정책 확인  
  2. Auth Service의 gRPC 서버 로그 및 헬스체크(Ready/Liveness Probe) 상태 점검  
  3. 클라이언트 설정(포트, TLS 인증서) 재검토  
  4. 방화벽 설정, 네트워크 라우팅 등 외부 요인 확인

---

## 3. 데이터베이스 및 저장소 문제

### 3.1 DB 연결 및 쿼리 오류

- **증상**:  
  - 사용자 데이터 조회/저장 시 DB 오류 발생  
  - 500 Internal Server Error, SQL 에러 메시지

- **원인**:  
  - PostgreSQL 연결 정보(호스트, 포트, 사용자, 패스워드) 불일치  
  - 인덱스 누락, 쿼리 최적화 문제  
  - 트랜잭션 충돌 또는 DB 리소스 부족

- **해결 방법**:  
  1. 환경 변수 및 Secret에 설정된 DB 접속 정보를 재검토  
  2. DB 로그 및 쿼리 실행 계획(`EXPLAIN ANALYZE`) 확인  
  3. DB 리소스(CPU, 메모리) 사용량 및 연결 수 점검  
  4. 필요한 경우, DB 복구 절차(백업 복원) 또는 인스턴스 스케일 업 실행

---

## 4. 토큰 관리 및 검증 문제

### 4.1 토큰 검증 실패

- **증상**:  
  - 유효한 사용자의 요청에도 불구하고 토큰 검증 실패  
  - 401 Unauthorized 에러

- **원인**:  
  - 토큰 서명 오류 (RS256 키 불일치)  
  - 토큰 만료 또는 블랙리스트 등록
  - 토큰 파싱 오류(잘못된 클레임 포맷)

- **해결 방법**:  
  1. JWT 생성 및 검증 로직(패키지 `pkg/auth`) 로그 확인  
  2. 사용 중인 RS256 키와 `kid` 값 확인  
  3. 토큰의 `exp` 클레임과 현재 시간을 비교하여 만료 여부 확인  
  4. 블랙리스트 데이터(Redis 또는 DB) 확인 및 업데이트 여부 점검

---

## 5. 이벤트 및 메시징 문제

### 5.1 Kafka 이벤트 발행/소비 오류

- **증상**:  
  - Kafka에 이벤트가 발행되지 않거나, 소비자에서 이벤트를 수신하지 못함  
  - Kafka 관련 에러 로그 발생

- **원인**:  
  - Kafka 브로커 연결 실패, 토픽 설정 오류  
  - 인증/인증서 문제, 네트워크 지연  
  - 메시지 직렬화/역직렬화 오류

- **해결 방법**:  
  1. Kafka 클러스터 상태 및 네트워크 연결 상태 확인  
  2. Auth Service의 Kafka 프로듀서 설정 및 토픽 이름, 파티션 구성 재검토  
  3. 이벤트 메시지 포맷(예: JSON, Protobuf) 및 스키마 일관성 확인  
  4. 소비자 그룹 설정 및 오프셋 관리 확인  
  5. 필요 시, Kafka 관련 로그와 모니터링 도구(Prometheus, Grafana) 점검

---

## 6. 네트워크 및 인프라 문제

### 6.1 네트워크 지연 및 패킷 손실

- **증상**:  
  - 서비스 간 gRPC 호출 지연, 타임아웃 발생  
  - 응답 속도 저하, 클라이언트 에러 발생

- **원인**:  
  - 네트워크 혼잡, 방화벽 또는 로드 밸런서 설정 오류  
  - Kubernetes 클러스터 내 네트워크 정책 문제

- **해결 방법**:  
  1. 네트워크 상태 및 클러스터 내 노드 상태 점검  
  2. 방화벽, 로드 밸런서 설정 확인 및 조정  
  3. gRPC 연결의 KeepAlive 및 타임아웃 설정 재검토  
  4. 서비스 메시 또는 Ingress 설정에서의 TLS 설정 점검

---

## 7. 일반 문제 해결 절차

1. **로그 분석**:  
   - 문제 발생 시, 관련 로그(애플리케이션, DB, Kafka, 네트워크)를 확인하여 원인 파악
2. **모니터링 도구 활용**:  
   - Prometheus, Grafana, ELK Stack을 통해 실시간 메트릭 및 로그 분석
3. **재현 및 테스트**:  
   - 테스트 환경에서 문제 상황을 재현하여 원인 분석 및 해결 방안 검증
4. **문서화**:  
   - 문제 해결 후, 원인 및 해결 방안을 문서화하여 향후 참조

---

## 8. 결론

**문제 해결 가이드**는 **ImmersiVerse Authentication Service**의 안정적 운영을 위해 발생 가능한 문제에 대해 신속하게 진단하고 대응할 수 있도록 돕는 핵심 자료입니다.  
- 각 문제 상황에 대한 원인 파악, 해결 방법, 모니터링 및 로그 분석 방법을 체계적으로 정리하여, 팀 내 지식 공유 및 문제 대응 시간을 단축합니다.  
- 팀원들은 이 가이드를 참조하여 문제 발생 시 신속하게 대응하고, 필요한 경우 개선 사항을 업데이트해 주세요.

---